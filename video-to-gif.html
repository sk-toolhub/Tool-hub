<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Test Video to GIF</title>
<script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.4/dist/ffmpeg.min.js"></script>
<style>
body { font-family:sans-serif; padding:20px; }
video, img { max-width:300px; display:block; margin:10px 0; }
button, a { margin:5px; padding:8px 12px; cursor:pointer; }
#downloadWrap a, #downloadWrap button { display:inline-block; }
.progress { width:300px; background:#eee; height:15px; margin-top:10px; position:relative; }
.progress > i { display:block; height:100%; width:0%; background:blue; transition:width .2s; }
.progress span { position:absolute; top:0; left:50%; transform:translateX(-50%); color:#fff; font-size:12px; }
</style>
</head>
<body>

<h2>Test Video to GIF</h2>
<input type="file" id="videoFile" accept="video/*"><br>
<video id="origPreview" controls></video>
<img id="gifPreview"><br>

<div class="progress"><i id="progressBar"></i><span id="progressText">0%</span></div>
<div id="downloadWrap"></div>

<button id="convertBtn">Convert to GIF</button>
<button id="clearBtn">Reset</button>

<script>
const { createFFmpeg, fetchFile } = FFmpeg;
const ffmpeg = createFFmpeg({ log:true });
const videoFileInput = document.getElementById('videoFile');
const origPreview = document.getElementById('origPreview');
const gifPreview = document.getElementById('gifPreview');
const convertBtn = document.getElementById('convertBtn');
const clearBtn = document.getElementById('clearBtn');
const progressBar = document.getElementById('progressBar');
const progressText = document.getElementById('progressText');
const downloadWrap = document.getElementById('downloadWrap');

let currentFile = null;
let gifUrl = null;

videoFileInput.addEventListener('change', ()=>{
  const file = videoFileInput.files[0];
  if(file){
    currentFile = file;
    origPreview.src = URL.createObjectURL(file);
  }
});

function setProgress(p){
  progressBar.style.width = p + '%';
  progressText.textContent = p + '%';
}

convertBtn.addEventListener('click', async ()=>{
  if(!currentFile) return alert('Upload video first!');
  convertBtn.disabled = true; clearBtn.disabled = true;
  downloadWrap.innerHTML = '';
  if(gifUrl){ URL.revokeObjectURL(gifUrl); gifUrl=null; gifPreview.src=''; }

  if(!ffmpeg.isLoaded()) await ffmpeg.load();
  const inName = 'input.mp4';
  const outName = 'out.gif';
  ffmpeg.FS('writeFile', inName, await fetchFile(currentFile));

  ffmpeg.setProgress(({ratio})=>setProgress(Math.floor(ratio*80)));

  try{
    await ffmpeg.run('-i', inName, '-t', '3', '-vf', 'fps=10,scale=320:-1:flags=lanczos,palettegen', 'palette.png');
    await ffmpeg.run('-i', inName, '-i', 'palette.png', '-lavfi', 'fps=10,scale=320:-1:flags=lanczos[x];[x][1:v] paletteuse', outName);
    const data = ffmpeg.FS('readFile', outName);
    const blob = new Blob([data.buffer], {type:'image/gif'});
    gifUrl = URL.createObjectURL(blob);
    gifPreview.src = gifUrl;
    setProgress(100);

    // Download button
    const a = document.createElement('a');
    a.href = gifUrl;
    a.download = 'video.gif';
    a.textContent = 'â¬‡ Download GIF';
    downloadWrap.appendChild(a);

    // Review button
    const btn = document.createElement('button');
    btn.textContent = 'ðŸ‘ Review GIF';
    btn.onclick = ()=>{ window.open(gifUrl); };
    downloadWrap.appendChild(btn);

  }catch(e){ alert('Error: '+e.message); }
  convertBtn.disabled=false; clearBtn.disabled=false;
});

clearBtn.addEventListener('click', ()=>{
  videoFileInput.value=''; origPreview.src=''; gifPreview.src=''; downloadWrap.innerHTML=''; gifUrl=null; setProgress(0);
});
</script>
</body>
</html>
